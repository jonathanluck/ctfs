#Pinlock

### Reversing


#### Finding the ciphertexts and passwords
Our only file in the challenge is an apk file. The first thing we should do is decompile it, which can be done [online](http://www.javadecompilers.com/apk)

Under `assets/pinlock.db`, we have a database that appears to store encrypted information.

Under the `pinDB` table, we find a single entry with what appears to be a hash: `d8531a519b3d4dfebece0259f90b466a23efc57b`

The tables for `secretsDBv1` and `secretsDBv2` each appear to have base64 encoded ciphertext (`hcsvUnln5jMdw3GeI4o/txB5vaEf1PFAnKQ3kPsRW2o5rR0a1JE54d0BLkzXPtqB` and `Bi528nDlNBcX9BcCC+ZqGQo1Oz01+GOWSmvxRj7jg1g=` respectively)

Googling the hash from the `pinDB` table reveals that it is the SHA-1 hash of `7498`

#### Decryption

Under `pinlock/ctf/pinlock/com/pinstore/` we find the source code for the application. 

The file `CryptoUtilities.java` conatins a function to generate encryption keys:

```java
    public SecretKeySpec getKey(String version) throws Exception {
        if (version.equalsIgnoreCase("v1")) {
            Log.d("Version", version);
            return new SecretKeySpec(Arrays.copyOf(MessageDigest.getInstance("SHA-1").digest("t0ps3kr3tk3y".getBytes("UTF-8")), 16), "AES");
        }
        Log.d("Version", version);
        byte[] salt = "SampleSalt".getBytes();
        return new SecretKeySpec(SecretKeyFactory.getInstance("PBKDF2WithHmacSHA1").generateSecret(new PBEKeySpec(this.pin.toCharArray(), salt, 1000, TransportMediator.FLAG_KEY_MEDIA_NEXT)).getEncoded(), "AES");
    }
```

From this and the table names, we can figure out the encryption keys for each ciphertext. 

The ciphertext in `secretsDBv1` was encrypted using AES with the key generated from SHA-1 hashing `t0ps3kr3tk3y`. The key will be the first 16 bytes of the hash. Decrypting this ciphertext leads us to some boring text that is not the flag.

The ciphertext in `secretsDBv2` was encrypted using AES with a key generated by 1000 of PBKDF2 using SHA-1, a salt of `SampleSalt`, a pin as a password (presumably `7498`), and a key length of 128 bits (from looking up the value of `TransportMediator.FLAG_KEY_MEDIA_NEXT`). We can generate the key in python using [hashlib](https://docs.python.org/3/library/hashlib.html#hashlib.pbkdf2_hmac):

```python
import hashlib, binascii
print(binascii.hexlify(hashlib.pbkdf2_hmac('sha1', b'7498', b'SampleSalt', 1000)[:16]))
```
We get the resulting 128-bit key encoded in hex as `cec65d2585db39ae9e1c226efa660b92`

Decrypting the ciphertext from `secretsDBv2` yields the flag: `Flag:OnlyAsStrongAsWeakestLink`